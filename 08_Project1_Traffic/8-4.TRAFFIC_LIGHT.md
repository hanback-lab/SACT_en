# Traffic Light Control 4
---

## 신호등 제어기 설계

앞에서 실습한 한 거리 신호등을 이용해 네거리 신호등을 설계해 보자.

동작에 대한 내용은 앞으 9-1장을 참고하면 된다. 


<BR><BR>

이전에 설계한 논리 회로를 이용해서 네거리 신호등 제어 회로를 설계하면 다음과 같다.

<img src="./pds/tf01a.png" alt="p03" style="width: 100%;">
<img src="./pds/tf01b.png" alt="p03" style="width: 100%;">
<img src="./pds/tf01c.png" alt="p03" style="width: 70%;">

<br><br>

1. 타이머 및 State 블록

    <img src="./pds/tf01a.png" alt="p03" style="width: 100%;"> <br>

    - 앞에서 실습한 한 거리의 신호등을 논리 회로인 TRAFFIC가 사용되었다. 
        - 1초 주기의 CLOCK의 입력으로 차도의 GREEN, LEFT, YELLOW, 횡단보도의 GREEN이 제어된다. <br>
    - TIMER[3]이 Falling Edge인 것에 의해 7490이 카운트 된다. 즉, TRAFFIC에서 0-9까지 카운트 될때 마다 7490이 카운트 되서 S[1..0]이 00, 01, 10, 11 카운트 된다. <br>
    -74139의 디코더를 사용해 S[1..0]의 값(00, 01, 10, 11)으로 인해 State가 SEL_N, SEL_E, SEL_S, SEL_W로 변경하도록 구성되어 있다. <br><br>

2. State에 의한 데이터 전달 블록

    <img src="./pds/tf01b.png" alt="p03" style="width: 100%;"><br>

    - 74157이라는 4비트 MUX를 사용했다. 
    - 네거리 신호등의 차도와 횡단보도의 LED를 제어하는데, TRAFFIC의 출력 신호가 SEL_N, SEL_E, SEL_S, SEL_W의 신호에 의해 전달된다. <BR><BR>
    
3. RED LED 제어

    <img src="./pds/tf01c.png" alt="p03" style="width: 100%;"><br>

    - 차도와 횡단보도의 RED LED가 제어되는 블록이다. 
    - SEL_N, SEL_E, SEL_S, SEL_W의 신호에 의해서, 선택되지 않았을 때 RED LED가 ON되도록 구성되어 있다. 

<BR>

신호등을 제어하기 위해서 아래 그림과 같이 구별하여 정의한다. 


<img src="./pds/tra05.png" alt="traffic" style="width: 70%;"><br>


CROSS는 차도의 신호등을 의미하고, WALK는 횡단보도의 신호등을 의미한다. . 

|1|2|3|4|
|:-:|:-:|:-:|:-:|
|NORTH_CROSS|EAST_CROSS|SOUTH_CROSS|WEST_CROSS|
|5|6|7|8|
|NORTH_WALK|EAST_WALK|SOUTH_WALK|WEST_WALK|


차도의 신호등은 아래와 같이 4개의 신호등으로 구성되어 있다. 

<img src="./pds/tra03.png" alt="traffic" style="width: 70%;"><br>

|RED|YELLOW|LEFT|GREEN|
|-|-|-|-|

횡단보도의 신호등은 아래와 같이 2개의 신호등으로 구성되어 있다. 

<img src="./pds/tra03a.png" alt="traffic" style="width: 25%;"><br>

|GREEN|RED|
|-|-|

<BR>

신호등의 각 위치 및 차도의 신호등일 때의 역할과 횡단보도의 신호등일 때의 역할에 따라 아래 표와 같이 이름을 정의하고, 장비에 적용했을 때 핀 번호를 표와 같이 설정한다. 

>하드웨어로 구성되어 있기 때문에 아래의 핀 번호와 다르면 이상 동작이 일어 날 수 있다. 
<BR>

|PORT NAME|CLK|
|:-:|:-:|
|HARDWARE|Main Clock|
|PIN NUMBER|G2|

|PORT NAME|N_C_G|N_C_L|N_C_Y|N_C_R|N_W_G|N_W_R|
|:-:|:-:|:-:|:-:|:-:|:-:|:-:|
|PIN NUMBER|W22|V22|Y21|W19|V21|W21|

|PORT NAME|E_C_G|E_C_L|E_C_Y|E_C_R|E_W_G|E_W_R|
|:-:|:-:|:-:|:-:|:-:|:-:|:-:|
|PIN NUMBER|T16|V16|AB16|W17|Y17|U17|

|PORT NAME|S_C_G|S_C_L|S_C_Y|S_C_R|S_W_G|S_W_R|
|:-:|:-:|:-:|:-:|:-:|:-:|:-:|
|PIN NUMBER|AB18|AB19|AB20|AA22|AA16|U16|

|PORT NAME|W_C_G|W_C_L|W_C_Y|W_C_R|W_W_G|W_W_R|
|:-:|:-:|:-:|:-:|:-:|:-:|:-:|
|PIN NUMBER|AA18|AA19|AA20|AA21|W20|Y22|

   <br>

   <img src="./pds/tra02.png" alt="sowt-ow" style="width: 60%;">


<br>


### **설계**

1. 실험을 위해 Quartus의 File > New Project Wizard 메뉴를 선택하여 새 프로젝트 생성한다. 

2. Directory, Name, Top-Level Entry 창을 다음과 같이 설정한다. 

    |Working Directory|d:\work\TRAFFIC|
    |-|-|
    |project Name |TRAFFIC|
    |Top Level Entry Name | TRAFFIC|

3. Family, Device & Board Setting 창에서 먼저 아래와 같이 Device Family/Package /Pin Count/Core speed grade를 설정하고, Name를 설정한다. 

    |Device Family|Cyclone 10 LP|
    |-|:-:|
    |Package|FBGA|
    Pin count|484|
    |Core Speed grade|8|
    |Available devices|10CL080YF484C8G|

>디바이스의 Name이 달라지면, Programming이 되지 않기 때문에 주의해야 한다. 

4. Summary를 확인해 지금 설정된 내용을 확인한 후, Finish를 눌러 프로젝트 생성을 마친다. 

5. 이전에 만든 TC를 사용하기 위해서, TC 프로젝트에 있는 TC.bdf, COMP2.bdf, COMP2.bsf, COMP4.bdf, comp4.bsf, CNT10.bdf, CNT10.bsf 파일을 현재 프로젝트 directory TRAFFIC에 복사한다. 

 >   TC.bdf파일이 다른 심볼을 포함하고 있지만, 컴파일 될 때 프로젝트 directory안에 있어야 에러를 발생하지 않기 때문에 이 파일들을 복사해 주어야 한다. 

6. File > Open에서 TC.bdf 파일을 불러오고, File > Create / Update > Create Symbol Files for Current File 메뉴를 선택하여 TC 심볼을 생성한다. 

7. File > New 메뉴를 눌러서 New 창을 불러온 후, Block Diagram/Schematic File을 선택한다.

8. 도면에서 마우스의 오른쪽 버튼을 눌러 Insert > Symbol 메뉴를 선택(도면을 마우스로 더블 클릭 해도 됨.)하여 input 심볼과 output 심볼, 그리고 앞에서 생성한 TC 심볼을 불러와 도면에 배치한다. 

9. 다음 그림과 같이 input과 output의 이름을 수정하고, 그외 회로를 완성시키는데 필요한 심볼들을 추가해 심볼 사이를 wire로 연결하여 도면을 완성시킨다. 

    <img src="./pds/tf01a.png" alt="p03" style="width: 100%;">
    <img src="./pds/tf01b.png" alt="p03" style="width: 100%;">
    <img src="./pds/tf01c.png" alt="p03" style="width: 70%;">

10. Save 한다. 이 때, 파일명을 Project 명(기본 설정, TRAFFIC)으로 설정한다. 

### **컴파일**

11. Processing > Start Compilation 메뉴를 선택하여, 컴파일을 진행한다. 

    설계된 부분의 오류가 있는지를 검사하고, 합성 / 타이밍 정보 생성 / 프로그래밍 파일 생성 을 하는 과정이다. 

### **시뮬레이션**


12. 컴파일이 완료되면 시뮬레이션을 진행한다. 

    File > New 메뉴를 선택하고, 나타나는 New 창에서 Verification/Debugging Files 항목의 University Program VWF 항목을 선택한다. 
    
13. Simulation Waveform Editor창에서 Edit > Insert > Insert Node or Bus 메뉴를 선택한다. 

<BR>
    <img src="./pds/cnt10_10.png" alt="traffic" style="width: 70%;"><br><br>

14. Node Finder 버튼을 누르고, Node Finder 창에서 List 버튼을 누르고, Nodes Found에서 >> 버튼을 누른다. 그리고, OK 버튼을 눌러 Simulation Waveform Editor 창에 입출력 포트를 추가한다. 

15. 시뮬레이션 되는 시간을 늘리기 위해서 Edit > Set End Time 메뉴를 선택하여, End time을 10us로 변경한다. 
<br>
    <img src="./pds/tf02.png" alt="traffic" style="width: 40%;"><br><br>
    <img src="./pds/tf02a.png" alt="traffic" style="width: 40%;"><br><br>


16. Simulation Waveform Editor창에서 CLK 부분을 마우스로 선택하여 입력 CLK의 전체를 선택한 후, 위의 [clock] 아이콘을 선택하여 Period를 100ns로 설정한다.

    <img src="./pds/tf03.png" alt="traffic" style="width: 100%;"><br><br>

17. SAVE를 한다. 파일명은 기본 상태 그대로 놓는다. 


18. 시뮬레이션을 하기 전에, Simulation > Simulation Setting 메뉴를 선택하여, 나타나는 창에서 -novopt 부분을 지운다. 

    <img src="./pds/cnt10_14.png" alt="traffic" style="width: 50%;"><br><br>
    <img src="./pds/cnt10_14a.png" alt="traffic" style="width: 80%;"><br><br>

    >이 -novopt를 제거하지 않으면, 시뮬레이션을 진행했을 때 아래와 같은 메시지가 나타난다. 

    <img src="./pds/cnt10_14b.png" alt="traffic" style="width: 80%;"><br><br>


19. Simulation > Run Functional Simulation 메뉴를 선택하여 시뮬레이션을 진행한다. 

    클럭이 발생하고, 그 클럭에 의해서 일정 구간마다 값이 N -> E -> S -> W -> N 이렇게 전달되어 출력되는 것을 확인할 수 있다.

   <img src="./pds/tf04.png" alt="traffic" style="width: 100%;"><br><br>


### Device & Pin Assignment

20. 시뮬레이션을 통해 설계된 논리 회로의 동작을 예상해 보았다면, 장비를 통해서 하드웨어의 동작을 확인해 보아야 한다. 

    장비를 확인하기 위해서, 입출력 포트에 대한 핀을 설정해 주어야 한다. 
<br>

21. 먼저 Assignment > Device 항목을 선택한다. 

    나타난 Device 설정 창에서 Device and Pin Options 버튼을 누른다. 

   <img src="./pds/cnt10_16.png" alt="traffic" style="width: 60%;"><br><br>
   <img src="./pds/cnt10_16a.png" alt="traffic" style="width: 70%;"><br><br>
   
22. Device & Pin Option 창에서 Unused Pins 카테고리를 선택하고, Reserve all unused pins를 As output driving ground로 설정한다. 

    이렇게 하는 이유는 기본 설정 값이 As input tri-stated with weak pull-up 인데, 이렇게 할 때 설정하지 않은 핀들이 약간의 pull-up 상태 즉 High의 상태가 된다. 

    장비에 구성된 LED등의 요소가 많기 때문에, As output driving ground로 설정하지 않으면 설정하지 않은 LED에 ON되어 출력된 결과에 혼동이 올 수 있다. 그래서 왠만하면 Unused Pin을 As output driving ground로 설정 해 주는 것이 좋다. 

    <img src="./pds/cnt10_17.png" alt="traffic" style="width: 80%;"><br><br>

23. Assignment > Pin Planner 메뉴를 선택하여 핀 번호를 설정한다. 


    <br>
    <img src="./pds/cnt10_18.png" alt="traffic" style="width: 80%;"><br><br>


24. 핀 번호는 Location 부분에 아래 표와 같이 핀 번호를 설정해 주면 된다. 

    핀 번호를 다르게 설정하면, 장비에서 동작을 확인하기 어렵기 때문에 핀 번호를 일치시켜 줘야 한다. 


|PORT NAME|CLK|
|:-:|:-:|
|HARDWARE|Main Clock|
|PIN NUMBER|G2|

|PORT NAME|N_C_G|N_C_L|N_C_Y|N_C_R|N_W_G|N_W_R|
|:-:|:-:|:-:|:-:|:-:|:-:|:-:|
|PIN NUMBER|W22|V22|Y21|W19|V21|W21|

|PORT NAME|E_C_G|E_C_L|E_C_Y|E_C_R|E_W_G|E_W_R|
|:-:|:-:|:-:|:-:|:-:|:-:|:-:|
|PIN NUMBER|T16|V16|AB16|W17|Y17|U17|

|PORT NAME|S_C_G|S_C_L|S_C_Y|S_C_R|S_W_G|S_W_R|
|:-:|:-:|:-:|:-:|:-:|:-:|:-:|
|PIN NUMBER|AB18|AB19|AB20|AA22|AA16|U16|

|PORT NAME|W_C_G|W_C_L|W_C_Y|W_C_R|W_W_G|W_W_R|
|:-:|:-:|:-:|:-:|:-:|:-:|:-:|
|PIN NUMBER|AA18|AA19|AA20|AA21|W20|Y22|

   <br>

   <img src="./pds/tra02.png" alt="sowt-ow" style="width: 60%;">

<br><br>

25. 핀 설정 후 창을 닫고, Processing > Start Compilation 메뉴를 선택하여 컴파일을 진행한다. 

    이것은 최종적으로 설정한 Device 옵션과 핀 설정 정보를 포함한 프로그래밍 파일을 만들기 위한 것이다. 

    
### **하드웨어 동작 확인**

26. SACT 장비를 준비한다. USB 케이블과 파워 케이블을 연결하고, 전원 스위치를 눌러 장비에 전원을 인가시킨다. 

27. Quartus 소프트웨어에서 Tool > Programmer 메뉴를 선택한다.

28. Programmer창의 Hardware Setup이 USB Blaster가 연결되어 있는지 확인하고, Start 버튼을 눌러 프로그래밍 하고 장비에서 동작을 확인한다. 
<br>

29. 장비 중앙의 CLOCK 설정 블록에서 CLOCK SELECT SWITCH를 돌려 1Hz로 설정하고, 신호등에서의 동작을 확인해 보자. 


<img src="./pds/sact-freq.png" alt="sowt-ow" style="width: 40%;"> <BR>


<br>

<img src="./pds/tra02.png" alt="traffic" style="width: 70%;"><br>

<br>

## 응용 설계

30. 신호등의 동작을 다양화 해보자. 특정 신호의 입력이 들어오면 모든 노란불이 깜빡이는 회로를 설계해보자. 








