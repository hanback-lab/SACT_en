# 4비트 계산기 1
---

## 4비트 Adder / Substractor

사칙연산에서 가장 기본인 덧셈과 뺄셈에 대한 회로를 만들 것이다. 

설계하려는 장치는 4bit Adder 회로를 이용해 가산기와 감산기를 설계하는 회로이다. 


Combination Logic에서 4bit Adder/Subtractor 절에서 실습이 진행된 내용이다. <br>
<br>
그림에서 CTR 신호에 의해서 덧셈과 뺄셈이 결정된다. CTR 신호가 0일 때 가산기로 동작하고, CTR 신호가 1일 때 감산기로 동작한다. 

<img src="./pds/as01.png" alt="p03" style="width: 80%;">

<br>
<br>


이 회로에서 A - B의 값이 음수로 표시될 경우 2의 보수 값으로 표현이 된다. 

사람이 쉽게 볼수 있도록 이 부분을 수정하면 다음과 같다. 

<img src="./pds/as02.png" alt="p03" style="width: 80%;"><br>

4bit Adder를 더 사용하여 A와 B를 더한 값과 A에서 B를 뺀 값을 계산하고, B의 값이 A 값보다 더 커서 음수의 데이터가 나올 경우에도 부호 표시와 함께 계산된 값이 표현되도록 되어 있다. 

<BR>

SACT 장비에서 확인하기 위하여 연결된 장치와 장비에 연결된 핀 번호는 다음과 같다. 

|PORT NAME|CTR|
|:-:|:-:|
|HARDWARE|SW7|
|PIN NUMBER|W8|

|PORT NAME|A[3]|A[2]|A[1]|A[0]|
|:-:|:-:|:-:|:-:|:-:|
|HARDWARE|S7|S6|S5|S4|
|PIN NUMBER|Y6|W7|AB6|AA7|

|PORT NAME|B[3]|B[2]|B[1]|B[0]|
|:-:|:-:|:-:|:-:|:-:|
|HARDWARE|S3|S2|S1|S0|
|PIN NUMBER|Y7|V8|AB7|Y8|

|PORT NAME|SIGN|COUT|S[3]|S[2]|S[1]|S[0]|
|:-:|:-:|:-:|:-:|:-:|:-:|:-:|
|HARDWARE|LED7|LED6|LED5|LED4|LED3|LED2|
|PIN NUMBER|W2|Y1|Y2|Y3|AA3|AB3|


<br>

<img src="./pds/sact-as.png" alt="scmp4_t-cmp4_" style="width: 60%;">

### **설계**

1. 실험을 위해 Quartus의 File > New Project Wizard 메뉴를 선택하여 새 프로젝트 생성한다. 

2. Directory, Name, Top-Level Entry 창을 다음과 같이 설정한다. 

    |Working Directory|d:\work\ADD_SUB_4|
    |-|-|
    |project Name | ADD_SUB_4|
    |Top Level Entry Name | ADD_SUB_4|

3. Project Type을 Empty project로 설정하고, Add File 창은 별다른 설정을 하지 않는다. 

4. Family, Device & Board Setting 창에서 먼저 아래와 같이 Device Family/Package /Pin Count/Core speed grade를 설정하고, Name를 설정한다. 

    |Device Family|Cyclone 10 LP|
    |-|:-:|
    |Package|FBGA|
    |Pin count|484|
    |Core Speed grade|8|
    |Available devices|10CL080YF484C8G|

    <img src="./pds/cnt10_02.png" alt="traffic" style="width: 100%;"><br><br>

>디바이스의 Name이 달라지면, Programming이 되지 않기 때문에 주의해야 한다. 

5. EDA Tool Settings도 별다른 설정을 하지 않는다. 

    Summary를 확인해 지금 설정된 내용을 확인한 후, Finish를 눌러 프로젝트 생성을 마친다. 

6. 이전에 Combination Logic에서 만든 4비트 가산기/감산기 논리 회로인 P_ADD_SUB 논리 회로를 활용하자. 

    활용하기 위해서, 이전의 P_ADD_SUB 작업 directory에서 현재 작업 directory인 ADD_SUB_4로 HA.bdf, HA.bsf, HAFA.bdf, HAFA.bsf, P_ADD_SUB.bdf 파일을 복사한다.

>  P_ADD_SUB가 별도로 만든 회로이기 때문에, 프로젝트 폴더에 포함시켜주어야 한다. 이렇게 하지 않으면 컴파일시 파일이 없다는 오류 메시지가 출력된다. 
<br>

7. 복사한 P_ADD_SUB4.bdf 파일을 File > Open 메뉴를 통해 불러온다. 


    <img src="./pds/as04.png" alt="traffic" style="width: 80%;"><br><br>

> 상위 논리 회로만 불러와서 심볼로 만들면 된다. 

8. 아래와 같이 File > Create / Update > Create Symbol Files for Current File 메뉴를 선택하여, 현재 불러온 논리 회로에 대한 심볼 파일을 생성한다. 

    이것은 Schmatic으로 논리 회로를 설계할 때에는 반드시 심볼을 이용해야 하기 때문이다. 


9. File > New 메뉴를 눌러서 New 창을 불러온 후, Block Diagram/Schematic File을 선택한다.

10. 도면에서 마우스의 오른쪽 버튼을 눌러 Insert > Symbol 메뉴를 선택(도면을 마우스로 더블 클릭 해도 됨.)하여 input 심볼과 output 심볼, gnd 심볼 그리고 P_ADD_SUB 심볼을 불러와서, 도면에 배치한다. 

    <img src="./pds/as05.png" alt="traffic" style="width: 80%;"><br><br>

11. 다음 그림과 같이 input과 output의 이름을 수정하고, 심볼을 더 추가해 심볼 사이를 wire로 연결하여 도면을 완성시킨다. 

    <img src="./pds/as06.png" alt="traffic" style="width: 100%;"><br><br>

12. Save 한다. 이 때, 파일명을 Project 명(기본 설정)으로 설정한다. 

### **컴파일**

13. Processing > Start Compilation 메뉴를 선택하여, 컴파일을 진행한다. 

    설계된 부분의 오류가 있는지를 검사하고, 합성 / 타이밍 정보 생성 / 프로그래밍 파일 생성 을 하는 과정이다. 

### **시뮬레이션**


14. 컴파일이 완료되면 시뮬레이션을 진행한다. 

    File > New 메뉴를 선택하고, 나타나는 New 창에서 Verification/Debugging Files 항목의 University Program VWF 항목을 선택한다. 
    
15. Simulation Waveform Editor창에서 Edit > Insert > Insert Node or Bus 메뉴를 선택한다. 

16. Node Finder 버튼을 누르고, Node Finder 창에서 List 버튼을 누르고, Nodes Found에서 >> 버튼을 누른다. 그리고, OK 버튼을 눌러 Simulation Waveform Editor 창에 입출력 포트를 추가한다. 

17. Simulation Waveform Editor창에서 다음그림과 같이 A 포트 중 일부를 마우스로 드래그하여 선택한 후  ? 아이콘을 눌러, 입력 조건의 데이터를 입력한다. B 포트도 같은 방법으로 데이터를 입력한다. 

    CTR은  0 또는 1의 아이콘을 눌러 값을 설정한다. 

    <img src="./pds/as-w01.png" alt="traffic" style="width: 100%;"><br><br>

18. SAVE를 한다. 파일명은 기본 상태 그대로 놓는다. 

19. 시뮬레이션을 하기 전에, Simulation > Simulation Setting 메뉴를 선택하여, 나타나는 창에서 -novopt 부분을 지운다. 

    <img src="./pds/cnt10_14a.png" alt="traffic" style="width: 80%;"><br><br>

    >이 -novopt를 제거하지 않으면, 시뮬레이션을 진행했을 때 아래와 같은 메시지가 나타난다. 

    <img src="./pds/cnt10_14b.png" alt="traffic" style="width: 80%;"><br><br>


20. Simulation > Run Functional Simulation 메뉴를 선택하여 시뮬레이션을 진행한다. 

    A와 B 데이터에 대해서 CTR이 0일 때의 덧셈 결과와 CTR이 1일 때의 뺄셈 결과를 확인할 수 있다. 

    COUT은 덧셈에서 Overflow가 발생하였을 때 나타나고, Sign은 뺄셈에서 B가 A보다 클 경우 나타난다. 

   <img src="./pds/as07.png" alt="traffic" style="width: 100%;"><br><br>
    <br>
    위의 데이터는 결과가 Binary로 나타나서 한눈에 파악하기 힘들다. 
    <br><br>
    아래 그림과 같이 입력 포트 A와 B, 출력 S를 마우스로 선택하여, Edit > Radix > Unsigned Decimal로 선택하여 시뮬레이션된 결과가 10진수로 보이도록 한다. 
    <br><br>
    <img src="./pds/as-w03.png" alt="traffic" style="width: 100%;"><br><br>
    <img src="./pds/as-w04.png" alt="traffic" style="width: 60%;"><br><br>
    <img src="./pds/as-w05.png" alt="traffic" style="width: 1000%;"><br><br>


### Device & Pin Assignment

21. 시뮬레이션을 통해 설계된 논리 회로의 동작을 예상해 보았다면, 장비를 통해서 하드웨어의 동작을 확인해 보아야 한다. 

    장비를 확인하기 위해서, 입출력 포트에 대한 핀을 설정해 주어야 한다. 
<br>

22. 먼저 Assignment > Device 항목을 선택한다. 

    나타난 Device 설정 창에서 Device and Pin Options 버튼을 누른다. 
   
23. Device & Pin Option 창에서 Unused Pins 카테고리를 선택하고, Reserve all unused pins를 As output driving ground로 설정한다. 

    이렇게 하는 이유는 기본 설정 값이 As input tri-stated with weak pull-up 인데, 이렇게 할 때 설정하지 않은 핀들이 약간의 pull-up 상태 즉 High의 상태가 된다. 

    장비에 구성된 LED등의 요소가 많기 때문에, As output driving ground로 설정하지 않으면 설정하지 않은 LED에 ON되어 출력된 결과에 혼동이 올 수 있다. 그래서 왠만하면 Unused Pin을 As output driving ground로 설정 해 주는 것이 좋다. 

    <img src="./pds/cnt10_17.png" alt="traffic" style="width: 80%;"><br><br>
<br>

24. Assignment > Pin Planner 메뉴를 선택하여 핀 번호를 설정한다. 


25. 핀 번호는 Location 부분에 아래 표와 같이 핀 번호를 설정해 주면 된다. 

    핀 번호를 다르게 설정하면, 장비에서 동작을 확인하기 어렵기 때문에 핀 번호를 일치시켜 줘야 한다. 

|PORT NAME|CTR|
|:-:|:-:|
|HARDWARE|SW7|
|PIN NUMBER|W8|

|PORT NAME|A[3]|A[2]|A[1]|A[0]|
|:-:|:-:|:-:|:-:|:-:|
|HARDWARE|S7|S6|S5|S4|
|PIN NUMBER|Y6|W7|AB6|AA7|

|PORT NAME|B[3]|B[2]|B[1]|B[0]|
|:-:|:-:|:-:|:-:|:-:|
|HARDWARE|S3|S2|S1|S0|
|PIN NUMBER|Y7|V8|AB7|Y8|

|PORT NAME|SIGN|COUT|S[3]|S[2]|S[1]|S[0]|
|:-:|:-:|:-:|:-:|:-:|:-:|:-:|
|HARDWARE|LED7|LED6|LED5|LED4|LED3|LED2|
|PIN NUMBER|W2|Y1|Y2|Y3|AA3|AB3|


<br>

<img src="./pds/sact-as.png" alt="scmp4_t-cmp4_" style="width: 60%;">

26. 핀 설정 후 창을 닫고, Processing > Start Compilation 메뉴를 선택하여 컴파일을 진행한다. 

    이것은 최종적으로 설정한 Device 옵션과 핀 설정 정보를 포함한 프로그래밍 파일을 만들기 위한 것이다. 
<br><br>
    
### **하드웨어 동작 확인**

27. SACT 장비를 준비한다. USB 케이블과 파워 케이블을 연결하고, 전원 스위치를 눌러 장비에 전원을 인가시킨다. 

28. Quartus 소프트웨어에서 Tool > Programmer 메뉴를 선택한다.

29. Programmer창의 Hardware Setup이 USB Blaster가 연결되어 있는지 확인하고, Start 버튼을 눌러 프로그래밍 하고 장비에서 동작을 확인한다. 

<br>

30. A와 B의 값을 (S7-S4), (S3-S0)의 슬라이드 스위치를 움직여 데이터를 설정하고, 버튼 스위치 SW7을 이용하여 덧셈 또는 뺄셈의 결과를 LED를 통해 확인하자.


|PORT NAME|CTR|
|:-:|:-:|
|HARDWARE|SW7|

|PORT NAME|A[3]|A[2]|A[1]|A[0]|
|:-:|:-:|:-:|:-:|:-:|
|HARDWARE|S7|S6|S5|S4|

|PORT NAME|B[3]|B[2]|B[1]|B[0]|
|:-:|:-:|:-:|:-:|:-:|
|HARDWARE|S3|S2|S1|S0|

|PORT NAME|SIGN|COUT|S[3]|S[2]|S[1]|S[0]|
|:-:|:-:|:-:|:-:|:-:|:-:|:-:|
|HARDWARE|LED7|LED6|LED5|LED4|LED3|LED2|


<br>

<img src="./pds/sact-as.png" alt="scmp4_t-cmp4_" style="width: 60%;">


<br>










