# Secret Code(DoorLock) 1
---

## KeyPad Controller

Digital doorlock uses KEYPAD with a total of 12 inputs consisting of 0~9, * and #. 

The equipment also has this keypad configured.

12 data lines are required in order to use 12 buttons of 0~9, #, *. 

It is configured in 3 x 4 format so that 12 inputs can be received with 7 data lines. 

KEYPADS control circuit is as below.

<img src="./pds/sca04.png" alt="scmp4_t-cmp4_" style="width: 60%;"><BR><BR>

Device can receive 12 button input of 3x4 keypad. Pull-down resistor is used and all data lines have default value of '0'.

Pass data of [1 0 0 0], [0 1 0 0], [0 0 1 0], [0 0 0 1] to 4-bit KEYPAD_R[3..0] and detect what data entered at KEYPAD_C[2..0] to check which key is pressed.

The following table shows KEYPAD control data.

|KEYPADS|BCD[3..0]||KEYPAD_R[3..0]|KEYPAD_C[2..0]|
|:-:|:-:|:-:|:-:|:-:|
|1| 0 0 0 1 || 1 0 0 0 | 1 0 0 |
|2| 0 0 1 0 || 1 0 0 0 | 0 1 0 |
|3| 0 0 1 1 || 1 0 0 0 | 0 0 1 |
|4| 0 1 0 0 || 0 1 0 0 | 1 0 0 |
|5| 0 1 0 1 || 0 1 0 0 | 0 1 0 |
|6| 0 1 1 0 || 0 1 0 0 | 0 0 1 |
|7| 0 1 1 1 || 0 0 1 0 | 1 0 0 |
|8| 1 0 0 0 || 0 0 1 0 | 0 1 0 |
|9| 1 0 0 1 || 0 0 1 0 | 0 0 1 |
|*| 1 0 1 0 || 0 0 0 1 | 1 0 0 |
|0| 0 0 0 0 || 0 0 0 1 | 0 1 0 |
|#| 1 0 1 1 || 0 0 0 1 | 0 0 1 |


There are no BCD values for * and # characters. Set to [ 1 0 1 0 ] and [ 1 0 1 1] respectively to verify the operation.

Devices and pin numbers connected on SACT equipment are as below.


|PORT NAME|CLK|
|:-:|:-:|
|HARDWARE|Main Clock|
|PIN NUMBER|G2|

|PORT NAME|K_R[3]|K_R[2]|K_R[1]|K_R[0]|
|:-:|:-:|:-:|:-:|:-:|
|HARDWARE|KEYPAD_R[3]|KEYPAD_R[2]|KEYPAD_R[1]|KEYPAD_R[0]|
|PIN NUMBER|AB10|AA10|V11|U11|

|PORT NAME|K_C[2]|K_C[1]|K_C[0]|
|:-:|:-:|:-:|:-:|
|HARDWARE|KEYPAD_C[2]|KEYPAD_C[1]|KEYPAD_C[0]|
|PIN NUMBER|U10|Y10|W10|

|PORT NAME|BCD[3]|BCD[2]|BCD[1]|BCD[0]|ZERO|
|:-:|:-:|:-:|:-:|:-:|:-:|
|HARDWARE|LED7|LED6|LED5|LED4|LED5|
|PIN NUMBER|W2|Y1|Y2|Y3|AA3|

<br>

<img src="./pds/kp01.png" alt="scmp4_t-cmp4_" style="width: 60%;">

<br><br>

### **Design**

1. Select File > New Project Wizard in Quartus to create new project.

2. Set Directory, Name, and Top-Level Entry window as below. 


    |Working Directory|d:\work\KEYPADS|
    |-|-|
    |project Name | KEYPADS|
    |Top Level Entry Name | KEYPADS|

3. Set Project Type to Empty project, and do not set Add File window.

4. In Family, Device&Board Setting window, first set Device Family/Package/Pin Count/Core speed grade as shown below, and then set Name.


    |Device Family|Cyclone 10 LP|
    |-|:-:|
    |Package|FBGA|
    |Pin count|484|
    |Core Speed grade|8|
    |Available devices|10CL080YF484C8G|

    <img src="./pds/cnt10_02.png" alt="traffic" style="width: 100%;"><br><br>

>Be careful that if device name changes, programming is not possible.

5. Do not set ‘EDA Tool Settings’.
Check Summary to confirm the current settings and click Finish to complete project creation.
 
6. Click File > New menu to open New window and select Block Diagram/Schematic File.

7. Right-click on the drawing and select Insert > Symbol menu (double-click on the drawing). Import input symbol, output symbol, 7490 symbol and place them on the drawing.

8. Complete the drawing by modifying the names of input and output, adding more symbols and connecting the symbols with wire as shown below.


    <img src="./pds/kp02a.png" alt="traffic" style="width: 100%;"><br><br>

    - The circuit above is a block that outputs the value of KEYPAD_R to KEYPAD and receives the value of KEYPAD_C corresponding to the pressed key

    - 4COUNT is 4-bit counter, but use only 2 bits to operate as 2-bit counter.

    - 74139 is 2x4 DECODER to pass the value to K_R as shown below.

        |NO.|K_R[3..0]|
        |:-:|:-:|
        |1| 1 0 0 0 |
        |2| 0 1 0 0 |
        |3| 0 0 1 0 |
        |4| 0 0 0 1 |
        |5| 1 0 0 0 |
    
    - Circuit consisting of combination logic of K_C value and CLK value in CLK input of 4COUNT circuit is designed. This is to stop the count and fix the value passed to K_R when there is an input in K_C, that is, when there is an input in KEYPADS.


    If it is not done, BCD input data in the comparator keep changing, making it operate like the button is being pressed continuously.
    <BR>

    <img src="./pds/kp02b.png" alt="traffic" style="width: 100%;"><br><br>

    - The circuit above compares the output K_R value with the input K_C value to find data about the currently pressed button data.


It can be configured as the table below.

   |KEYPADS|K_R[3..0]|K_C[2..0]| Formula |
   |:-:|:-:|:-:|:-:|
   |KEY_1| 1 0 0 0 | 1 0 0 | K_R3 & K_C2 | 
   |KEY_2| 1 0 0 0 | 0 1 0 | K_R3 & K_C1 |
   |KEY_3| 1 0 0 0 | 0 0 1 | K_R3 & K_C0 |
   |KEY_4| 0 1 0 0 | 1 0 0 | K_R2 & K_C2 |
   |KEY_5| 0 1 0 0 | 0 1 0 | K_R2 & K_C1 |
   |KEY_6| 0 1 0 0 | 0 0 1 | K_R2 & K_C0 |
   |KEY_7| 0 0 1 0 | 1 0 0 | K_R1 & K_C2 |
   |KEY_8| 0 0 1 0 | 0 1 0 | K_R1 & K_C1 |
   |KEY_9| 0 0 1 0 | 0 0 1 | K_R1 & K_C0 |
   |KEY_10(*)| 0 0 0 1 | 1 0 0 | K_R0 & K_C2 |
   |KEY_0| 0 0 0 1 | 0 1 0 | K_R0 & K_C1 |
   |KEY_11(#)| 0 0 0 1 | 0 0 1 | K_R0 & K_C0 |

<BR>


<img src="./pds/kp02c.png" alt="traffic" style="width: 100%;"><br><br>

- The circuit above converts KEY value recognized above into BCD data to configure in the circuit.

    It can be configured based on the data of BCD[3], BCD[2], BCD[1], BCD[0].

   |BCD[3..0] Formula|
   |:-|
   |BCD[0] = KEY_1 + KEY_3 + KEY_5 + KEY_7 + KEY_9 + KEY_11(#)|
   |BCD[1] = KEY_2 + KEY_3 + KEY_6 + KEY_7 + KEY_10(*) + KEY_11(#)|
   |BCD[2] = KEY_4 + KEY_5 + KEY_6 + KEY_7 |
   |BCD[3] = KEY_8 + KEY_9 + + KEY_10(*) + KEY_11(#)|

   Since KEY_0 has BCD value of 0000, port of ZERO was added to respond to key 0.
 

<br><br>   

9. Save. Set file name to project name (default setting).

### **Compile**

10. Select Processing > Start Compilation menu to proceed with compilation.
This is the process of checking for errors in the design and synthesizing/ generating timing information / generating programming file.


### Device & Pin Assignment

11. Check the operation of the hardware through equipment.

    To check the equipment, set the pin for input/output port.

12. Select Assignment > Device.

    In the Device Settings window that appears, click ‘Device and Pin Options’ 

13. In ‘Device & Pin Option’ window, select “Unused Pins” category and set “Reserve all unused pins” to “As output driving ground”.
    
    It is because that default setting is “As input tri-stated with weak pull-up”, which causes the pins not set to be slightly pulled up, in High state.
    
    Since there are many elements such as LED configured in the equipment, if ‘As output driving ground’ is not set, unset LED may become ON causing output result confusing. Therefore, it is recommended to set Unused Pin as ‘As output driving ground’.


    <img src="./pds/cnt10_17.png" alt="traffic" style="width: 80%;"><br><br>
<br>

14. Select Assignment > Pin Planner to set PIN number.

15. Set PIN number in Location as shown in the table below.
If PIN number is set differently, it will be difficult to check the operation of the device.


|PORT NAME|CLK|
|:-:|:-:|
|HARDWARE|Main Clock|
|PIN NUMBER|G2|

|PORT NAME|K_R[3]|K_R[2]|K_R[1]|K_R[0]|
|:-:|:-:|:-:|:-:|:-:|
|HARDWARE|KEYPAD_R[3]|KEYPAD_R[2]|KEYPAD_R[1]|KEYPAD_R[0]|
|PIN NUMBER|AB10|AA10|V11|U11|

|PORT NAME|K_C[2]|K_C[1]|K_C[0]|
|:-:|:-:|:-:|:-:|
|HARDWARE|KEYPAD_C[2]|KEYPAD_C[1]|KEYPAD_C[0]|
|PIN NUMBER|U10|Y10|W10|

|PORT NAME|BCD[3]|BCD[2]|BCD[1]|BCD[0]|ZERO|
|:-:|:-:|:-:|:-:|:-:|:-:|
|HARDWARE|LED7|LED6|LED5|LED4|LED5|
|PIN NUMBER|W2|Y1|Y2|Y3|AA3|

<br>

<img src="./pds/kp01.png" alt="scmp4_t-cmp4_" style="width: 60%;">

<br>
<br>

16. After setting the pin, close the window and select Processing > Start Compilation menu to proceed with compilation. 

    This is to create a programming file that includes Device option and Pin configuration information.
    
<br><br>
    
### **Check Hardware Operation**

17. Prepare SACT equipment. Connect USB cable and power cable and press the power switch to supply power to the device.

18. In Quartus software, select Tool > Programmer.

19. Check that USB Blaster is connected in Hardware Setup on Programmer window. Press Start button to program to check the operation on the device.

20. Set to 1kHz using CLOCK SELECT SWITCH of CLOCK block and check that  BCD value corresponding to the pressed key is output on LED by pressing KEYPADS button.



|PORT NAME|CLK|
|:-:|:-:|
|HARDWARE|Main Clock|

|PORT NAME|K_R[3]|K_R[2]|K_R[1]|K_R[0]|
|:-:|:-:|:-:|:-:|:-:|
|HARDWARE|KEYPAD_R[3]|KEYPAD_R[2]|KEYPAD_R[1]|KEYPAD_R[0]|

|PORT NAME|K_C[2]|K_C[1]|K_C[0]|
|:-:|:-:|:-:|:-:|
|HARDWARE|KEYPAD_C[2]|KEYPAD_C[1]|KEYPAD_C[0]|

|PORT NAME|BCD[3]|BCD[2]|BCD[1]|BCD[0]|ZERO|
|:-:|:-:|:-:|:-:|:-:|:-:|
|HARDWARE|LED7|LED6|LED5|LED4|LED5|

<br>

<img src="./pds/kp01.png" alt="scmp4_t-cmp4_" style="width: 60%;">










